----- Subquery  

-- example
SELECT 	film_id,title,rental_rate
FROM film
WHERE rental_rate > (
SELECT
AVG (rental_rate)
FROM film);


--PostgreSQL subquery with IN operator
SELECT
	film_id,
	title
FROM
	film
WHERE
	film_id IN (
		SELECT
			inventory.film_id
		FROM
			rental
		INNER JOIN inventory ON inventory.inventory_id = rental.inventory_id
		WHERE
			return_date BETWEEN '2005-05-29'
		AND '2005-05-30'
	);


/* PostgreSQL subquery with EXISTS operator
   EXIST : rows가 존재하는지 확인 하기 위해, 존재 시 True
   select에 1 또는 * 사용 
*/

select first_name,last_name 
from customer
where exists ( 
select 1 
from payment
where payment.customer_id=customer.customer_id);

/*NOT EXISTS example
      NOT EXISTS TRUE - subquery returns no row
                      FALSE - one more rows 
*/

    SELECT first_name,
       last_name
FROM customer c
WHERE NOT EXISTS
    (SELECT 1
     FROM payment p
     WHERE p.customer_id = c.customer_id
       AND amount > 11 )
ORDER BY first_name,
         last_name;


/*PostgreSQL subquery with ANY operator
   하나라도 성립하면 true 
    ANY = IN
    BUT <> ANY != NOT IN 
*/

SELECT
    category_id, MAX( length )
FROM
  film
INNER JOIN film_category
        USING(film_id)
GROUP BY
    category_id
ORDER BY 
category_id;


--PostgreSQL subquery with ALL operator

select film_id,title,length
from film
where length > all(
select round(avg(length),2)
	from film
	group by rating 
	)
	order by length;
